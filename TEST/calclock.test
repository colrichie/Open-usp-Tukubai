#!/usr/local/bin/bash -xv
#
# test script of calclock
#
# usage: ./calclock.test <python ver>

name=calclock
    
tmp=/tmp/$$
dir=$(dirname $0)/..
cd $dir
    
com="$2 ./$1/${name}"
[ "$1" = "" ] && com="./$1/${name}"

ERROR_CHECK(){
	[ "$(echo ${PIPESTATUS[@]} | tr -d ' 0')" = "" ] && return

	echo $1
	echo "$com" NG
#	rm -f $tmp-*
	exit 1
}

###########################################
#TEST1

cat << FIN > $tmp-in
0001 0000007 20060201 20060206 117 8335 -145
0001 0000007 20060203 20060206 221 15470 0
0001 0000007 20060205 20060206 85 5950 0
0001 0000007 20060206 20060206 293 20527 -17
0001 0000007 20060207 20060206 445 31150 0
0002 0000007 20060208 20060206 150 11768 -1268
0002 0000007 20060209 20060206 588 41160 0
0002 0000007 20060210 20060206 444 31080 0
FIN

cat << FIN > $tmp-ans
0001 0000007 20060201 1138719600 20060206 1139151600 117 8335 -145
0001 0000007 20060203 1138892400 20060206 1139151600 221 15470 0
0001 0000007 20060205 1139065200 20060206 1139151600 85 5950 0
0001 0000007 20060206 1139151600 20060206 1139151600 293 20527 -17
0001 0000007 20060207 1139238000 20060206 1139151600 445 31150 0
0002 0000007 20060208 1139324400 20060206 1139151600 150 11768 -1268
0002 0000007 20060209 1139410800 20060206 1139151600 588 41160 0
0002 0000007 20060210 1139497200 20060206 1139151600 444 31080 0
FIN

${com} 3 4 $tmp-in > $tmp-out
diff $tmp-ans $tmp-out
[ $? -eq 0 ] ; ERROR_CHECK "TEST1 error"

###########################################
#TEST2

cat << FIN > $tmp-in
0001 0000007 20060201 117 8335 -145
0001 0000007 20060203 221 15470 0
0001 0000007 20060205 85 5950 0
0001 0000007 20060206 293 20527 -17
0001 0000007 20060207 445 31150 0
0002 0000007 20060208 150 11768 -1268
0002 0000007 20060209 588 41160 0
0002 0000007 20060210 444 31080 0
FIN

cat << FIN > $tmp-ans
1138978800 20060204000000
1139151600 20060206000000
1139324400 20060208000000
1139410800 20060209000000
1139497200 20060210000000
1139583600 20060211000000
1139670000 20060212000000
1139756400 20060213000000
FIN

${com} 3 $tmp-in                |\
awk '{print $4+86400*3}'        |\
${com} -r 1 -                   > $tmp-out
#awk '{print substr($2,1,8)}'  	> $tmp-out     
diff $tmp-ans $tmp-out
[ $? -eq 0 ] ; ERROR_CHECK "TEST2 error"

rm -f $tmp-*
echo "${com}" OK
exit 0
